@model Pazaryeri.ViewModels.ProductViewModel

<h2>Ürün Ekle</h2>

<form asp-action="Create" method="post" enctype="multipart/form-data" id="productForm">
    @Html.AntiForgeryToken()

    <div class="row">
        <div class="col-md-8">
            <!-- Temel Bilgiler -->
            <div class="card mb-4">
                <div class="card-header"><h5>Temel Bilgiler</h5></div>
                <div class="card-body">
                    <div class="form-group">
                        <label asp-for="Title"></label>
                        <input asp-for="Title" class="form-control" />
                        <span asp-validation-for="Title" class="text-danger"></span>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="ProductMainId"></label>
                                <input asp-for="ProductMainId" class="form-control" />
                                <span asp-validation-for="ProductMainId" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="ProductCode"></label>
                                <input asp-for="ProductCode" class="form-control" />
                                <span asp-validation-for="ProductCode" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <input type="hidden" asp-for="Description" id="Description" />
                        <label asp-for="Description"></label>
                        <div id="editor" style="height:200px">@Html.Raw(Model.Description)</div>
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>

                    <div class="form-group">
                        <label asp-for="BrandId"></label>
                        <select asp-for="BrandId" asp-items="Model.Brands" class="form-control select2"></select>
                        <span asp-validation-for="BrandId" class="text-danger"></span>
                    </div>

                    <div class="form-group">
                        <label asp-for="CategoryId"></label>
                        <select asp-for="CategoryId" asp-items="Model.Categories" class="form-control select2" id="CategoryId"></select>
                        <span asp-validation-for="CategoryId" class="text-danger"></span>
                    </div>


                    <div class="row">
                        <div class="col-md-6">
                            <label asp-for="Price"></label>
                            <input asp-for="Price" type="number" step="0.01" class="form-control" />
                            <span asp-validation-for="Price" class="text-danger"></span>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="StockQuantity"></label>
                            <input asp-for="StockQuantity" type="number" class="form-control" />
                            <span asp-validation-for="StockQuantity" class="text-danger"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dinamik Özellikler -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>Özellikler</h5>
                    <h5><span style="color:red">*</span> işaretli alanlar zorunludur.</h5>
                </div>
                <div class="card-body" id="attributeContainer">
                    Kategori seçilince özellikler otomatik yüklenecek...
                </div>
            </div>

            <!-- Varyasyonlar -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>Varyasyonlar</h5>
                    <button type="button" id="addVariant" class="btn btn-primary btn-sm">Varyasyon Ekle</button>
                </div>
                <div class="card-body" id="variantsContainer">
                </div>
            </div>
        </div>

        <!-- Görseller -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header"><h5>Ürün Görselleri</h5></div>
                <div class="card-body">
                    <input asp-for="ImageFiles" type="file" class="form-control" multiple accept="image/*" id="productImageInput" />
                    <div id="imagePreview">
                        <!-- Geçici resimlerin gösterileceği alan -->
                        @if (Model.TempProductImageUrls != null && Model.TempProductImageUrls.Any())
                        {
                            foreach (var imageUrl in Model.TempProductImageUrls)
                            {
                                <div class="image-preview-item">
                                    <img src="@imageUrl" alt="Preview" style="max-width: 100px; max-height: 100px;" />
                                    <input type="hidden" name="TempProductImageUrls" value="@imageUrl" />
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="form-group">
            <button type="submit" class="btn btn-success">Ürünü Kaydet ve Trendyol'a Gönder</button>
            <a asp-action="Index" class="btn btn-secondary">İptal</a>
        </div>
</form>

@section Scripts {
    <link rel="stylesheet" href="~/app-assets/vendors/css/editors/quill/quill.snow.css" />
    <script src="~/app-assets/vendors/js/editors/quill/quill.min.js"></script>
    <script src="~/app-assets/vendors/js/forms/repeater/jquery.repeater.min.js"></script>

    <script>
        $(".select2").select2();

        let variantCounter = 0;
        let currentVariationAttributes = [];

        if (sessionStorage.getItem('variantsRestored')) {
            sessionStorage.removeItem('variantsRestored');
        } else {
            sessionStorage.setItem('variantsRestored', 'true');
        }

        $('#addVariant').click(function() {
            addVariantEditor();
        });

        function addVariantEditor(variantData = null) {
            variantCounter++;

            const tempId = variantData?.tempId || variantCounter;
            const variant = variantData || {
                tempId: tempId,
                sku: '',
                price: 0,
                stockQuantity: 0,
                barcode: '',
                variationAttributes: {}
            };

            const requestData = {
                tempId: tempId,
                variationAttributes: currentVariationAttributes || [],
                variantData: {
                    tempId: variant.tempId,
                    sku: variant.sku || '',
                    price: variant.price || 0,
                    stockQuantity: variant.stockQuantity || 0,
                    barcode: variant.barcode || '',
                    variationAttributes: variant.variationAttributes || {}
                }
            };

            $.ajax({
                url: '@Url.Action("GetVariantEditor")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(requestData),
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    $('#variantsContainer').append(response);
                    initializeVariantEvents();
                    $('.select2').select2();
                },
                error: function(xhr, status, error) {
                    console.error('Varyasyon editor yüklenemedi:', error);
                    toastr.error('Varyasyon eklenirken hata oluştu.');
                    createVariantManually(requestData);
                }
            });
        }

        function createVariantManually(requestData) {
            const tempId = requestData.tempId;
            const variant = requestData.variantData;

            const variantHtml = `
                    <div class="variant-editor card mb-3" data-variant-id="${tempId}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">Varyasyon ${tempId}</h6>
                            <button type="button" class="btn btn-sm btn-danger remove-variant">Kaldır</button>
                        </div>
                        <div class="card-body">
                            <input type="hidden" name="VariantIds" value="${tempId}" />

                            <div class="variation-attributes mb-3">
                                ${renderVariationAttributesManually(tempId, requestData.variationAttributes)}
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>SKU *</label>
                                        <input type="text" name="Variants[${tempId}].Sku" value="${variant.sku}" class="form-control" required />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Barkod</label>
                                        <input type="text" name="Variants[${tempId}].Barcode" value="${variant.barcode}" class="form-control" />
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Fiyat *</label>
                                        <input type="number" step="0.01" name="Variants[${tempId}].Price" value="${variant.price}" class="form-control" required />
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Stok *</label>
                                        <input type="number" name="Variants[${tempId}].StockQuantity" value="${variant.stockQuantity}" class="form-control" required />
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Varyasyon Resimleri</label>
                                        <input type="file" name="Variants[${tempId}].ImageFiles" class="form-control variant-image-input" multiple accept="image/*" />
                                        <div class="variant-image-preview mt-2"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

            $('#variantsContainer').append(variantHtml);
            initializeVariantEvents();
        }

        function renderVariationAttributesManually(tempId, attributes) {
            if (!attributes || attributes.length === 0) {
                return '<p class="text-muted">Varyasyon özelliği bulunmuyor</p>';
            }

            let html = '';
            attributes.forEach(attr => {
                html += `
            <div class="form-group">
                <label>${attr.name}</label>
                <select name="Variants[${tempId}].VariationAttributes[${attr.id}]" class="form-control">
                    <option value="">Seçiniz</option>
        `;

                if (attr.values && attr.values.length > 0) {
                    attr.values.forEach(value => {
                        const selected = variant.variationAttributes &&
                            variant.variationAttributes[attr.id] === value.id ? 'selected' : '';
                        html += `<option value="${value.id}" ${selected}>${value.name}</option>`;
                    });
                }

                html += `</select></div>`;
            });

            return html;
        }

        function updateVariationAttributes(attributes) {
            currentVariationAttributes = attributes.filter(attr => attr.varianter);

            $('.variant-editor').each(function () {
                const variantId = $(this).data('variant-id');
                updateVariantAttributes($(this), variantId);
            });
        }

        function updateVariantAttributes(container, variantId) {
            const attributesContainer = container.find('.variation-attributes');
            attributesContainer.empty();

            if (currentVariationAttributes.length === 0) {
                attributesContainer.html('<p class="text-muted">Varyasyon özelliği bulunmuyor</p>');
                return;
            }

            currentVariationAttributes.forEach(attr => {
                const selectHtml = `
            <div class="form-group">
                <label>${attr.name}</label>
                <select name="Variants[${variantId}].VariationAttributes[${attr.id}]"
                        class="form-control variation-attribute-select">
                    <option value="">Seçiniz</option>
                    ${attr.values.map(value =>
                    `<option value="${value.id}">${value.name}</option>`
                ).join('')}
                </select>
            </div>
        `;
                attributesContainer.append(selectHtml);
            });
        }

        function initializeVariantEvents() {
            $('.remove-variant').off('click').on('click', function() {
                $(this).closest('.variant-editor').remove();
                updateVariantIds();
            });

            $('.variant-editor').each(function () {
                var variantId = $(this).data('variant-id');
                initializeVariantImagePreview(variantId);

                // Geçici resimleri göster
                showTempVariantImages(variantId, $(this));
            });
        }

        function updateVariantIds() {
            const variantIds = [];
            $('.variant-editor').each(function() {
                const variantId = $(this).data('variant-id');
                variantIds.push(variantId);
            });

            $('input[name="VariantIds"]').remove();
            variantIds.forEach(id => {
                $('#variantsContainer').append(`<input type="hidden" name="VariantIds" value="${id}" />`);
            });
        }

        $('#CategoryId').change(function() {
            const categoryId = $(this).val();

            if (!categoryId) {
                $('#attributeContainer').html('Kategori seçilince özellikler otomatik yüklenecek...');
                $('#variantsContainer').empty();
                variantCounter = 0;
                currentVariationAttributes = [];
                return;
            }

            $.get('@Url.Action("GetCategoryAttributes")', { categoryId: categoryId })
                .done(function(response) {
                    if (response.success) {
                        var attributeValues = @Html.Raw(Json.Serialize(Model.AttributeValues ?? new Dictionary<int, string>()));

                        renderAttributes(response.data.categoryAttributes, attributeValues);
                        updateVariationAttributes(response.data.categoryAttributes);

                        if ($('.variant-editor').length === 0) {
                            addVariantEditor();
                        } else {
                            $('.variant-editor').each(function () {
                                const variantId = $(this).data('variant-id');
                                updateVariantAttributes($(this), variantId);
                            });
                        }

                    }
                })
                .fail(function() {
                    toastr.error('Kategori özellikleri yüklenirken hata oluştu.');
                });
        });

        function renderAttributes(attributes, attributeValues) {
            if (!attributes || attributes.length === 0) {
                $('#attributeContainer').html('<p class="text-muted">Kategori seçilince özellikler otomatik yüklenecek...</p>');
                return;
            }

            let html = '<div class="row">';

            attributes.forEach(attr => {
                if (!attr.varianter) {
                    html += `<div class="col-md-6"><div class="form-group">
                                <label>${attr.name} ${attr.required ? '<span style="color:red">*</span>' : ''}</label>`;

                    var attributeValue = '';
                    if (attributeValues && attributeValues[attr.id] !== undefined) {
                        attributeValue = attributeValues[attr.id];
                    }

                    if (attr.allowCustom) {
                        html += `<input type="text" name="AttributeValues[${attr.id}]" value="${attributeValue}" class="form-control" ${attr.required ? 'required' : ''} />`;
                    } else {
                        const multiple = attr.allowMultipleAttributeValues ? 'multiple' : '';
                        html += `<select name="AttributeValues[${attr.id}]${multiple ? '[]' : ''}" class="form-control select2" ${attr.required ? 'required' : ''} ${multiple}>`;
                        html += '<option value="">Seçiniz</option>';

                        attr.values.forEach(value => {
                            let selected = '';
                            if (multiple) {
                                if (attributeValue && Array.isArray(attributeValue)) {
                                    selected = attributeValue.includes(value.id.toString()) ? 'selected' : '';
                                } else if (attributeValue) {
                                    const valuesArray = attributeValue.split(',');
                                    selected = valuesArray.includes(value.id.toString()) ? 'selected' : '';
                                }
                            } else {
                                selected = (attributeValue == value.id.toString()) ? 'selected' : '';
                            }
                            html += `<option value="${value.id}" ${selected}>${value.name}</option>`;
                        });
                        html += '</select>';
                    }
                    html += `</div></div>`;
                }
            });

            html += '</div>';
            $('#attributeContainer').html(html);
            $('.select2').select2();
        }

        function renderVariationAttributes(attributes) {
            currentVariationAttributes = attributes.filter(attr => attr.varianter);
        }

        $(document).ready(function () {

            var categoryAttributes = @Html.Raw(Json.Serialize(Model.CategoryAttributes ?? new List<Pazaryeri.ViewModels.CategoryAttributeViewModel>()));
            var attributeValues = @Html.Raw(Json.Serialize(Model.AttributeValues ?? new Dictionary<int, string>()));


            if (categoryAttributes && categoryAttributes.length > 0) {
                renderAttributes(categoryAttributes, attributeValues);
                updateVariationAttributes(categoryAttributes);
            }

           var initialVariants = @Html.Raw(Json.Serialize(Model?.Variants ?? new List<Pazaryeri.ViewModels.ProductVariantViewModel>()));

            currentVariationAttributes = @Html.Raw(Json.Serialize(Model?.CategoryAttributes?.Where(a => a.Varianter) ?? new List<Pazaryeri.ViewModels.CategoryAttributeViewModel>()));

            if (initialVariants && initialVariants.length > 0) {
                initialVariants.forEach(function(variant) {
                    addVariantEditor({
                        tempId: variant.tempId,
                        sku: variant.sku || '',
                        price: variant.price || 0,
                        stockQuantity: variant.stockQuantity || 0,
                        barcode: variant.barcode || '',
                        variationAttributes: variant.variationAttributes || {}
                    });
                });
            } else {
                setTimeout(function () {
                    addVariantEditor();
                }, 100);
            }

            var quill = new Quill("#editor", { theme: "snow" });

            $("form").on("submit", function() {
                $("#Description").val(quill.root.innerHTML);
            });
        });

        $('#productImageInput').change(function () {
            previewImages(this, '#imagePreview');
        });

        function previewImages(input, previewContainer) {
            $(previewContainer).empty();

            if (input.files) {
                for (var i = 0; i < input.files.length; i++) {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        $(previewContainer).append(`
                    <div class="image-preview-item mb-2">
                        <img src="${e.target.result}" alt="Preview" style="max-width: 80px; max-height: 80px;" class="img-thumbnail" />
                    </div>
                `);
                    }
                    reader.readAsDataURL(input.files[i]);
                }
            }
        }

        function showTempVariantImages(variantId, container) {
            var tempImageUrls = @Html.Raw(Json.Serialize(Model.TempVariantImageUrls ?? new Dictionary<int, List<string>>()));

            if (tempImageUrls && tempImageUrls[variantId]) {
                var previewContainer = container.find('.variant-image-preview');
                previewContainer.empty();

                tempImageUrls[variantId].forEach(function(imageUrl) {
                    previewContainer.append(`
                        <div class="image-preview-item mb-2">
                            <img src="${imageUrl}" alt="Preview" style="max-width: 80px; max-height: 80px;" class="img-thumbnail" />
                            <input type="hidden" name="TempVariantImageUrls[${variantId}]" value="${imageUrl}" />
                        </div>
                    `);
                });
            }
        }

        function initializeVariantImagePreview(variantId) {
            $(`input[name="Variants[${variantId}].ImageFiles"]`).change(function () {
                previewImages(this, $(this).closest('.variant-editor').find('.variant-image-preview'));
            });
        }
    </script>
}